<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beat Maker</title>
<link href="project.css" rel="stylesheet">
</head>
<body>
<header>
<h1>ISAAC'S BEAT MAKER</h1>
</header>


<main>
    <section id="instrument-selection">
        <h2>Select an Instrument</h2>
        <div class="instrument-button" id="drums">Drums</div>
        <div class="instrument-button" id="piano">Piano</div>
        <div class="instrument-button" id="guitar">Guitar</div>
    </section>

<section id="beat-buttons">
<h2>Choose your loop!</h2>

<div class="beat-button" id="drums1">Drum loop 1</div>
<div class="beat-button" id="drums2">Drum loop 2</div>
<div class="beat-button" id="drums3">Drum loop 3</div>

<div class="beat-button" id="piano1">Piano loop 1</div>
<div class="beat-button" id="piano2">Piano loop 2</div>
<div class="beat-button" id="piano3">Piano loop 3</div>

<div class="beat-button" id="guitar1">Guitar loop 1</div>
<div class="beat-button" id="guitar2">Guitar loop 2</div>
<div class="beat-button" id="guitar3">Guitar loop 3</div>
</section>

<section id="loop-controls">
<h2>Loop Controls</h2>
<button id="play-button">Play</button>
<button id="stop-button">Stop</button>
<button id="reset-button">Reset</button>
</section>
</main>


<script>
const apiKey = 'm9rfLaAaDPKd8Yy29tCsyIMFQT8AzsaDpLuBJNAu';

const audioContext = new (window.AudioContext || window.webkitAudioContext)();

//This allows me to keep track of the active audio sources for each instrument and layer

const activeSources = {
    drums: {1: [], 2: [], 3: [] },
    piano: {1: [], 2: [], 3: [] },
    guitar:{1: [], 2: [], 3: [] },
};

//fetches sound from Freesound.org

async function fetchSound(soundId) {
    const response = await fetch(`https://freesound.org/apiv2/sounds/${soundId}/?token=${apiKey}`);
    const data = await response.json();
    return data.previews['preview-hq-mp3'];
}

// This allows me to play a sound on a specific layer, sync it to beat 1

function playSound(instrument, layer, url) {
    const source = audioContext.createBufferSource();
    const currentTime = audioContext.currentTime;
    const timeUntilNextBeat = Math.ceil(currentTime) - currentTime;

    fetch(url)
    .then(response => response.arrayBuffer())
    .then(buffer => audioContext.decodeAudioData(buffer))
    .then(audioBuffer => {
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.loop = true;
        // This stores the active source for later manipulation
        source.start(currentTime + timeUntilNextBeat);
        activeSources[instrument][layer].push(source);
    })
    .catch(error => console.error('error loading sound', error));
}

//This is my event listeners for my instrument BUTTONS
document.getElementById('drums').addEventListener('click', () => {

    fetchSound('668530').then(url => playSound('drums', 1, url));
});


document.getElementById('piano').addEventListener('click', () => {

fetchSound('629169').then(url => playSound('piano', 1, url));
});


document.getElementById('guitar').addEventListener('click', () => {

fetchSound('575300').then(url => playSound('guitar', 1, url));
});

//Event listeners for each beat button

document.getElementById('drums1').addEventListener('click', () => {

fetchSound('668530').then(url => playSound('drums', 1, url));
});


document.getElementById('drums2').addEventListener('click', () => {

fetchSound('668544').then(url => playSound('drums', 2, url));
});


document.getElementById('drums3').addEventListener('click', () => {

fetchSound('668531').then(url => playSound('drums', 3, url));
});


document.getElementById('piano1').addEventListener('click', () => {

fetchSound('629169').then(url => playSound('piano', 1, url));
});


document.getElementById('piano2').addEventListener('click', () => {

fetchSound('629148').then(url => playSound('piano', 2, url));
});

document.getElementById('piano3').addEventListener('click', () => {

fetchSound('soundId').then(url => playSound('piano', 3, url));
});

document.getElementById('guitar1').addEventListener('click', () => {

fetchSound('575300').then(url => playSound('guitar', 1, url));
});


document.getElementById('guitar2').addEventListener('click', () => {

fetchSound('712897').then(url => playSound('guitar', 2, url));
});


document.getElementById('guitar3').addEventListener('click', () => {

fetchSound('433623').then(url => playSound('guitar', 3, url));
});


// loop controlz
document.getElementById('play-button').addEventListener('click', () => {
    //play all active sourcee
    Object.values(activeSources).forEach(instrument => {
        Object.values(instrument).forEach(layer => {
            layer.forEach(source => source.start());
        });
    });
});

document.getElementById('stop-button').addEventListener('click', () => {
    //stop sources
    Object.values(activeSources).forEach(instrument => {
        Object.values(instrument).forEach(layer => {
            layer.forEach(source => {
            source.stop();
            source.disconnect();
            source.loop = false;
        });
        layer.length = 0;
        });
    });
});

document.getElementById('reset-button').addEventListener('click', () => {
    //stop and disconnect all active sources
    Object.values(activeSources).forEach(instrument => {
        Object.values(instrument).forEach(layer => {
                layer.forEach(source => {
                    source.stop();
                    source.disconnect();
                });
                layer.length = 0;
        
        });
    });
});

</script>
</body>
</html>